machine:
  ruby:
    version: 2.2.0
  services:
    - docker
  environment:
    DOCKER_IMAGE_ELASTICSEARCH: docker.epages.com/epages/docs-elasticsearch
    DOCKER_IMAGE_NGINX: docker.epages.com/epages/docs-nginx
    DOCKER_IMAGE_TAG: ${CIRCLE_BRANCH//\//-}

test:
  override:
    - ./build.sh "${DOCKER_IMAGE_TAG}"

deployment:
  push:
    branch:
      - master
      - develop
    commands:
      - docker login -u "${DOCKER_LOGIN_USERNAME}" -p "${DOCKER_LOGIN_PASSWORD}" -e "${DOCKER_LOGIN_EMAIL}" docker.epages.com
      - docker push "${DOCKER_IMAGE_ELASTICSEARCH}:${DOCKER_IMAGE_TAG}"
      - docker push "${DOCKER_IMAGE_NGINX}:${DOCKER_IMAGE_TAG}"
